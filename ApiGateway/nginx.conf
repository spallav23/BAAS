upstream auth_service {
    server host.docker.internal:3001;
    keepalive 32;
}

upstream database_service {
    server host.docker.internal:3003;
    keepalive 32;
}

upstream storage_service {
    server host.docker.internal:3002;
    keepalive 32;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=auth_limit:1m rate=20r/m;
limit_req_zone $binary_remote_addr zone=api_limit:1m rate=100r/m;
limit_req_zone $binary_remote_addr zone=write_limit:1m rate=50r/m;

server {
    listen 80;
    server_name localhost;

    access_log /var/log/nginx/gateway_access.log;
    error_log /var/log/nginx/gateway_error.log;

    client_max_body_size 10M;
    client_body_timeout 30s;
    client_header_timeout 30s;

    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    send_timeout 30s;

    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Gateway "nginx";

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Root endpoint
    # location / {
    #     default_type application/json;
    #     return 200 '{"message":"BaaS Platform API Gateway","version":"1.0.0","status":"running"}';
    #     add_header Content-Type application/json;
    # }

    # Auth Service
    location /api/auth {
        limit_req zone=auth_limit burst=5 nodelay;
        
        proxy_pass http://auth_service;
        proxy_http_version 1.1;
        proxy_set_header Connection keep-alive;
        
        # Handle errors
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # Database Service
    location /api/db {
        limit_req zone=api_limit burst=10 nodelay;
        
        proxy_pass http://database_service;
        proxy_http_version 1.1;
        proxy_set_header Connection keep-alive;
        
        # Handle errors
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # Storage Service
    location /api/storage {
        limit_req zone=write_limit burst=5 nodelay;
        
        proxy_pass http://storage_service;
        proxy_http_version 1.1;
        proxy_set_header Connection keep-alive;
        
        # Handle errors
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # Default - 404
    location / {
        return 404 '{"error":"Not found","message":"Route not found"}';
        add_header Content-Type application/json;
    }
}

